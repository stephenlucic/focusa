{% extends 'base.html' %} 
{% load static %} 

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/dashboard.css' %}" />
{% endblock %} 

{% block content %}

{% if messages %}
  {% for m in messages %}
    <div class="alert alert-{{ m.tags }} d-flex justify-content-between align-items-center px-3 py-2 mb-3">
      <span>{{ m.message }}</span>
      <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
  {% endfor %}
{% endif %}

<div class="row metric-row">
  <div class="col-md-3">
    <div class="metric-card">
      <div class="metric-value">{{ resumen.tareas_pendientes }}</div>
      <div class="metric-label">Tareas pendientes</div>
    </div>
  </div>

  <div class="col-md-3">
    <div class="metric-card">
      <div class="metric-value">{{ resumen.tareas_por_hacer }}</div>
      <div class="metric-label">Tareas por hacer</div>
    </div>
  </div>

  <div class="col-md-3">
    <div class="metric-card">
      <div class="metric-value">{{ resumen.tareas_completadas }}</div>
      <div class="metric-label">Tareas completadas</div>
    </div>
  </div>

  <div class="col-md-3">
    <div class="metric-card">
      <div class="metric-value">{{ resumen.productividad_pct }}%</div>
      <div class="metric-label">Productividad</div>
    </div>
  </div>
</div>



<div class="row g-4 mb-4">


  <!-- Tareas por semana -->
  <div class="col-lg-6">
    <div class="card h-100 {% if not es_pro %}card-locked{% endif %}">
      <div class="card-header">Progreso semanal de tareas</div>
      <div class="card-body">
        {% if es_pro %}
          <div
            id="chart-productividad"
            class="focusa-chart"
            data-type="bar"
            data-height="300"
            data-labels='{{ productividad_labels_json|safe }}'
            data-series='{{ productividad_series_json|safe }}'
          ></div>
        {% else %}
          <div class="focusa-locked">
            <i class="bi bi-lock-fill lock-icon"></i>
            <p class="mb-2">Disponible solo en Focusa Pro</p>
            <a href="{% url 'suscripcion' %}" class="btn btn-sm btn-primary">Actualizar a Pro</a>
          </div>
        {% endif %}
      </div>
    </div>
  </div>

  <!-- Prioridades -->
  <div class="col-lg-6">
    <div class="card h-100 {% if not es_pro %}card-locked{% endif %}">
      <div class="card-header">Tareas por prioridad</div>
      <div class="card-body">
        {% if es_pro %}
          <div
            id="chart-prioridades"
            class="focusa-chart"
            data-type="pie"
            data-height="340"
            data-labels='{{ prioridades_labels_json|safe }}'
            data-series='{{ prioridades_series_json|safe }}'
          ></div>
        {% else %}
          <div class="focusa-locked">
            <i class="bi bi-lock-fill lock-icon"></i>
            <p class="mb-2">Disponible solo en Focusa Pro</p>
            <a href="{% url 'suscripcion' %}" class="btn btn-sm btn-primary">Actualizar a Pro</a>
          </div>
        {% endif %}
      </div>
    </div>
  </div>

</div>


<div class="row g-4 mb-4">

  <!-- Estados (dona) -->
  <div class="col-lg-6">
    <div class="card h-100 {% if not es_pro %}card-locked{% endif %}">
      <div class="card-header">Estados de tareas</div>
      <div class="card-body">
        {% if es_pro %}
          <div
            id="chart-estados"
            class="focusa-chart"
            data-type="donut"
            data-height="320"
            data-labels='{{ estados_labels_json|safe }}'
            data-series='{{ estados_values_json|safe }}'
          ></div>
        {% else %}
          <div class="focusa-locked">
            <i class="bi bi-lock-fill lock-icon"></i>
            <p class="mb-2">Disponible solo en Focusa Pro</p>
            <a href="{% url 'suscripcion' %}" class="btn btn-sm btn-primary">Actualizar a Pro</a>
          </div>
        {% endif %}
      </div>
    </div>
  </div>

  <!-- Progreso mensual -->
  <div class="col-lg-6">
    <div class="card h-100 {% if not es_pro %}card-locked{% endif %}">
      <div class="card-header">Progreso mensual</div>
      <div class="card-body">
        {% if es_pro %}
          <div
            id="chart-progreso"
            class="focusa-chart"
            data-type="area"
            data-stacked="true"
            data-height="320"
            data-labels='{{ meses_json|safe }}'
            data-series='{{ progreso_series_json|safe }}'
          ></div>
        {% else %}
          <div class="focusa-locked">
            <i class="bi bi-lock-fill lock-icon"></i>
            <p class="mb-2">Disponible solo en Focusa Pro</p>
            <a href="{% url 'suscripcion' %}" class="btn btn-sm btn-primary">Actualizar a Pro</a>
          </div>
        {% endif %}
      </div>
    </div>
  </div>

</div>

<div class="d-flex justify-content-end mb-3">
  {% if es_pro %}
    <a href="{% url 'export_dashboard_excel' %}" class="btn btn-success me-2">
      <i class="bi bi-file-earmark-excel"></i> Exportar Excel
    </a>
    <a href="{% url 'export_dashboard_pdf' %}" class="btn btn-danger">
      <i class="bi bi-file-earmark-pdf"></i> Exportar PDF
    </a>
  {% else %}
    <div class="export-locked-wrapper text-end">
      <button type="button" class="btn btn-outline-secondary me-2 export-locked" disabled>
        <i class="bi bi-lock-fill me-1"></i>
        Exportar Excel
      </button>
      <button type="button" class="btn btn-outline-secondary export-locked" disabled>
        <i class="bi bi-lock-fill me-1"></i>
        Exportar PDF
      </button>
      <small class="text-muted d-block mt-1">
        Función disponible solo en <strong>Focusa Pro</strong>
      </small>
    </div>
  {% endif %}
</div>


<div class="row g-4 mb-4">
  <!-- Tabla detalle tareas -->
  <div class="col-12">
    <div class="card">
      <div
        class="card-header d-flex justify-content-between align-items-center"
      >
        <span>Detalle de tareas</span>
        <small class="text-muted">Total: {{ tareas|length }}</small>
      </div>
      <div class="table-responsive">
        <table class="table table-sm table-hover align-middle mb-0 task-table">
          <thead>
            <tr>
              <th>Título</th>
              <th>Estado</th>
              <th>Prioridad</th>
              <th>Fecha creación</th>
              <th>Fecha límite</th>
              <th>% Avance</th>
            </tr>
          </thead>
          <tbody>
            {% for t in tareas %}
            <tr>
              <td>{{ t.titulo }}</td>
              <td>
                <span class="badge state-{{ t.estado|lower|slugify }}"
                  >{{ t.estado }}</span
                >
              </td>
              <td>
                <span class="badge priority-{{ t.prioridad|lower }}"
                  >{{ t.prioridad }}</span
                >
              </td>
              <td>{{ t.fecha_creacion|date:"d/m/Y" }}</td>
              <td>{{ t.fecha_limite|date:"d/m/Y" }}</td>
              <td>
                <div class="progress progress-thin">
                  <div
                    class="progress-bar"
                    style="width: {{ t.porcentaje }}%"
                  ></div>
                </div>
                <small class="text-muted">{{ t.porcentaje }}%</small>
              </td>
            </tr>
            {% empty %}
            <tr>
              <td colspan="6" class="text-center text-muted py-4">
                No hay tareas
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>  

  {% endblock %} 
  {% block extra_js %}
  <script src="https://cdn.jsdelivr.net/npm/apexcharts" defer></script>
  <script src="{% static 'js/focusa-theme.js' %}" defer></script>
  <script src="{% static 'js/dashboard.js' %}" defer></script>
  {% endblock %}
