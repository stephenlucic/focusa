{% extends "base.html" %}
{% load tz %}
{% load static %}

{% block title %}Focusa | Notificaciones{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/notificaciones.css' %}" />
{% endblock %}

{% block content %}
<div class="container my-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <div>
      <h2 class="mb-0">Notificaciones</h2>
      <small class="text-muted">
        Aquí puedes revisar el historial de cambios en tus tareas.
      </small>
    </div>

    <div class="d-flex gap-2">
      <form method="post" class="d-inline">
        {% csrf_token %}
        <button
          type="submit"
          class="btn btn-sm btn-outline-primary"
          {% if not notificaciones %}disabled{% endif %}
        >
          <i class="bi bi-check-all"></i> Marcar todas como leídas
        </button>
      </form>

      <button
        type="button"
        class="btn btn-sm btn-outline-danger"
        onclick="eliminarTodas()"
        {% if not notificaciones %}disabled{% endif %}
      >
        <i class="bi bi-trash"></i> Eliminar todas
      </button>
    </div>
  </div>

  {% if notificaciones %}
    <div class="card shadow-sm">
      <div class="card-body p-0">
        <ul class="list-group list-group-flush" id="notificacionesList">
          {% for n in notificaciones %}
            <li class="list-group-item" data-notif-id="{{ n.id }}">
              <button 
                type="button" 
                class="btn-delete-notif"
                onclick="eliminarNotificacion({{ n.id }})"
                title="Eliminar notificación"
              >
                <i class="bi bi-x-lg"></i>
              </button>
              
              <div class="d-flex justify-content-between align-items-start pe-4">
                <div class="flex-grow-1">
                  <!-- badge por tipo de acción -->
                  {% if n.accion == 'creacion' %}
                    <span class="badge bg-success me-2">Creación</span>
                  {% elif n.accion == 'actualizacion' %}
                    <span class="badge bg-warning text-dark me-2">Actualización</span>
                  {% elif n.accion == 'eliminacion' %}
                    <span class="badge bg-danger me-2">Eliminación</span>
                  {% endif %}

                  <!-- título + mensaje -->
                  <span class="{% if not n.leida %}fw-semibold{% endif %}">
                    {{ n.titulo }}
                  </span>
                  <div class="small text-muted mt-1">
                    {{ n.mensaje }}
                  </div>
                </div>

                <div class="text-end">
                  <!-- fecha en horario local -->
                  <div class="small text-muted">
                    {{ n.creada_en|localtime|date:"d/m/Y H:i" }}
                  </div>
                  <!-- tiempo relativo, opcional -->
                  <div class="small text-muted">
                    hace {{ n.creada_en|timesince }}
                  </div>
                  {% if not n.leida %}
                    <span class="badge bg-primary mt-1">Nueva</span>
                  {% endif %}
                </div>
              </div>
            </li>
          {% endfor %}
        </ul>
      </div>
    </div>
  {% else %}
    <div class="alert alert-success" role="alert">
      No tienes notificaciones por ahora ✅
    </div>
  {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script>
function getCookie(name) {
  let cookieValue = null;
  if (document.cookie && document.cookie !== '') {
    const cookies = document.cookie.split(';');
    for (let i = 0; i < cookies.length; i++) {
      const cookie = cookies[i].trim();
      if (cookie.substring(0, name.length + 1) === (name + '=')) {
        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
        break;
      }
    }
  }
  return cookieValue;
}
const csrftoken = getCookie('csrftoken');

function eliminarNotificacion(id) {
  Swal.fire({
    title: '¿Eliminar esta notificación?',
    text: 'Esta acción no se puede deshacer',
    icon: 'warning',
    showCancelButton: true,
    confirmButtonColor: '#dc3545',
    cancelButtonColor: '#6c757d',
    confirmButtonText: 'Sí, eliminar',
    cancelButtonText: 'Cancelar'
  }).then((result) => {
    if (result.isConfirmed) {
      fetch(`/notificacion/eliminar/${id}/`, {
        method: 'POST',
        headers: {
          'X-CSRFToken': csrftoken,
          'X-Requested-With': 'XMLHttpRequest'
        }
      })
      .then(r => r.json())
      .then(data => {
        if (data.ok) {
          const item = document.querySelector(`[data-notif-id="${id}"]`);
          if (item) {
            item.remove();
            // Si no quedan notificaciones, mostrar mensaje
            const list = document.getElementById('notificacionesList');
            if (list && list.children.length === 0) {
              location.reload();
            }
          }
          Swal.fire({
            title: 'Eliminada',
            icon: 'success',
            timer: 1500,
            showConfirmButton: false
          });
        }
      })
      .catch(err => {
        console.error(err);
        Swal.fire('Error', 'No se pudo eliminar la notificación', 'error');
      });
    }
  });
}

function eliminarTodas() {
  Swal.fire({
    title: '¿Eliminar todas las notificaciones?',
    text: 'Se eliminarán todas tus notificaciones. Esta acción no se puede deshacer.',
    icon: 'warning',
    showCancelButton: true,
    confirmButtonColor: '#dc3545',
    cancelButtonColor: '#6c757d',
    confirmButtonText: 'Sí, eliminar todas',
    cancelButtonText: 'Cancelar'
  }).then((result) => {
    if (result.isConfirmed) {
      fetch('/notificacion/eliminar-todas/', {
        method: 'POST',
        headers: {
          'X-CSRFToken': csrftoken,
          'X-Requested-With': 'XMLHttpRequest'
        }
      })
      .then(r => r.json())
      .then(data => {
        if (data.ok) {
          Swal.fire({
            title: 'Eliminadas',
            text: 'Todas las notificaciones han sido eliminadas',
            icon: 'success',
            timer: 1500,
            showConfirmButton: false
          }).then(() => {
            location.reload();
          });
        }
      })
      .catch(err => {
        console.error(err);
        Swal.fire('Error', 'No se pudo eliminar las notificaciones', 'error');
      });
    }
  });
}
</script>
{% endblock %}
