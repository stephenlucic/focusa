{% extends 'base.html' %}
{% load static %}

{% block title %}Panel de Administración{% endblock %}

{% block extra_css %}
<style>
.table-usuarios {
  font-size: 0.9rem;
}
.badge-inactivo {
  background-color: #dc3545;
}
.badge-reciente {
  background-color: #28a745;
}
.badge-moderado {
  background-color: #ffc107;
}
.user-avatar {
  width: 32px;
  height: 32px;
  border-radius: 50%;
  object-fit: cover;
}
.card {
  border-radius: 1.5rem;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2>Dashboard de Administración</h2>
    <a href="{% url 'exportar_dashboard_pdf' %}" class="btn btn-danger" target="_blank">
      <i class="bi bi-file-earmark-pdf me-2"></i>Exportar PDF
    </a>
  </div>

  <!-- Tarjetas de métricas principales -->
  <div class="row g-3 mb-4">
    <div class="col-md-3">
      <div class="card text-center">
        <div class="card-body">
          <h5 class="card-title text-muted">Total Usuarios</h5>
          <p class="display-4 mb-0">{{ total_users }}</p>
        </div>
      </div>
    </div>
    
    <div class="col-md-3">
      <div class="card text-center">
        <div class="card-body">
          <h5 class="card-title text-muted">Usuarios Activos</h5>
          <p class="display-4 mb-0 text-success">{{ active_users }}</p>
        </div>
      </div>
    </div>
    
    <div class="col-md-3">
      <div class="card text-center">
        <div class="card-body">
          <h5 class="card-title text-muted">Administradores</h5>
          <p class="display-4 mb-0 text-primary">{{ admins_count }}</p>
        </div>
      </div>
    </div>
    
    <div class="col-md-3">
      <div class="card text-center">
        <div class="card-body">
          <h5 class="card-title text-muted">Usuarios Normales</h5>
          <p class="display-4 mb-0 text-info">{{ usuarios_count }}</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Día pico -->
  {% if peak_day %}
  <div class="row mb-4">
    <div class="col-md-6">
      <div class="card">
        <div class="card-body">
          <h5 class="card-title">Día con más conexiones (últimos 30 días)</h5>
          <p class="mb-1"><strong>Fecha:</strong> {{ peak_day.day }}</p>
          <p class="mb-0"><strong>Conexiones:</strong> {{ peak_day.count }}</p>
        </div>
      </div>
    </div>
  </div>
  {% endif %}

  <!-- Logins por día (últimos 7 días) -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="card">
        <div class="card-body">
          <h5 class="card-title">Conexiones por día (últimos 7 días)</h5>
          <div id="loginsChart"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Tabla de usuarios con actividad -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="card">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="card-title mb-0">Actividad de Usuarios</h5>
            <div class="text-muted small">
              <span class="badge badge-reciente">Activo (&lt;7 días)</span>
              <span class="badge badge-moderado">Moderado (7-30 días)</span>
              <span class="badge badge-inactivo">Inactivo (&gt;30 días)</span>
            </div>
          </div>
          <div class="table-responsive">
            <table class="table table-usuarios table-hover">
              <thead>
                <tr>
                  <th>Usuario</th>
                  <th>Email</th>
                  <th>Grupo</th>
                  <th>Estado</th>
                  <th>Total Logins</th>
                  <th>Última Conexión</th>
                  <th>Días Inactivo</th>
                  <th>Acciones</th>
                </tr>
              </thead>
              <tbody>
                {% for info in usuarios_info %}
                <tr>
                  <td>
                    <div class="d-flex align-items-center">
                      {% if info.user.perfil.foto_perfil %}
                        <img src="{{ info.user.perfil.foto_perfil.url }}" class="user-avatar me-2" alt="{{ info.user.username }}">
                      {% else %}
                        <div class="user-avatar me-2 bg-secondary d-flex align-items-center justify-content-center text-white">
                          {{ info.user.username|slice:":1"|upper }}
                        </div>
                      {% endif %}
                      <span>{{ info.user.username }}</span>
                    </div>
                  </td>
                  <td>{{ info.user.email }}</td>
                  <td><span class="badge bg-secondary">{{ info.grupos }}</span></td>
                  <td>
                    {% if info.user.is_active %}
                      <span class="badge bg-success">Activo</span>
                    {% else %}
                      <span class="badge bg-secondary">Inactivo</span>
                    {% endif %}
                  </td>
                  <td class="text-center">{{ info.total_logins }}</td>
                  <td>
                    {% if info.ultimo_login %}
                      {{ info.ultimo_login|date:"d/m/Y H:i" }}
                    {% else %}
                      <span class="text-muted">Nunca</span>
                    {% endif %}
                  </td>
                  <td>
                    {% if info.dias_inactivo is not None %}
                      {% if info.dias_inactivo < 7 %}
                        <span class="badge badge-reciente">{{ info.dias_inactivo }} días</span>
                      {% elif info.dias_inactivo < 30 %}
                        <span class="badge badge-moderado">{{ info.dias_inactivo }} días</span>
                      {% else %}
                        <span class="badge badge-inactivo">{{ info.dias_inactivo }} días</span>
                      {% endif %}
                    {% else %}
                      <span class="badge bg-secondary">N/A</span>
                    {% endif %}
                  </td>
                  <td>
                    <a href="{% url 'admin_usuarios' %}" class="btn btn-sm btn-outline-primary" title="Ver detalles">
                      <i class="bi bi-eye"></i>
                    </a>
                    {% if info.dias_inactivo and info.dias_inactivo > 30 and info.user.is_active %}
                      <button class="btn btn-sm btn-outline-warning" onclick="confirmarDesactivacion({{ info.user.id }}, '{{ info.user.username }}')" title="Usuario inactivo, considerar desactivar">
                        <i class="bi bi-person-fill-dash"></i>
                      </button>
                    {% endif %}
                  </td>
                </tr>
                {% empty %}
                <tr>
                  <td colspan="8" class="text-center text-muted">No hay usuarios registrados</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Últimas conexiones -->
  <div class="row">
    <div class="col-12">
      <div class="card">
        <div class="card-body">
          <h5 class="card-title">Últimas 10 conexiones</h5>
          <div class="table-responsive">
            <table class="table table-sm table-hover">
              <thead>
                <tr>
                  <th>Usuario</th>
                  <th>Fecha y Hora</th>
                  <th>IP</th>
                </tr>
              </thead>
              <tbody>
                {% for log in recent_logins %}
                <tr>
                  <td>{{ log.user.username }}</td>
                  <td>{{ log.timestamp|date:"d/m/Y H:i" }}</td>
                  <td>{{ log.ip_address|default:"N/A" }}</td>
                </tr>
                {% empty %}
                <tr>
                  <td colspan="3" class="text-center text-muted">No hay registros</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
  const loginsData = {{ logins_per_day_json|safe }};
  
  console.log('Datos de logins:', loginsData); // Debug en consola

  if (!loginsData || loginsData.length === 0) {
    document.querySelector("#loginsChart").innerHTML = '<p class="text-muted text-center py-4">No hay datos para mostrar en los últimos 7 días</p>';
    return;
  }

  const labels = loginsData.map(d => d.day);
  const data = loginsData.map(d => d.count);

  const options = {
    chart: {
      type: 'line',
      height: 300,
      toolbar: {
        show: false
      }
    },
    series: [{
      name: 'Conexiones',
      data: data
    }],
    xaxis: {
      categories: labels,
      title: {
        text: 'Fecha'
      }
    },
    yaxis: {
      title: {
        text: 'Número de conexiones'
      },
      min: 0
    },
    stroke: {
      curve: 'smooth',
      width: 2
    },
    colors: ['#4bc0c0'],
    fill: {
      type: 'gradient',
      gradient: {
        shadeIntensity: 1,
        opacityFrom: 0.4,
        opacityTo: 0.1,
        stops: [0, 90, 100]
      }
    },
    dataLabels: {
      enabled: false
    }
  };

  const chart = new ApexCharts(document.querySelector("#loginsChart"), options);
  chart.render();
});

function confirmarDesactivacion(userId, username) {
  Swal.fire({
    title: '¿Desactivar usuario?',
    html: `El usuario <strong>${username}</strong> lleva más de 30 días sin conectarse.<br>¿Deseas desactivarlo?`,
    icon: 'warning',
    showCancelButton: true,
    confirmButtonColor: '#ffc107',
    cancelButtonColor: '#6c757d',
    confirmButtonText: 'Sí, desactivar',
    cancelButtonText: 'Cancelar'
  }).then((result) => {
    if (result.isConfirmed) {
      window.location.href = `/admin-usuarios/toggle-activo/${userId}/`;
    }
  });
}
</script>
{% endblock %}