{% extends 'base.html' %}
{% load static %}

{% block title %}Focusa | Kanban Board{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/kanban.css' %}">
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <h2 class="mb-0">Tablero Kanban</h2>
  <button class="btn btn-primary">
    <i class="bi bi-plus-lg"></i> Nueva Tarea
  </button>
</div>

<div class="kanban-container">
  <div class="kanban-board">
    
    <!-- Columna To Do -->
    <div class="kanban-column column-todo">
      <div class="kanban-header">
        <h5 class="d-flex align-items-center">
          Por Hacer
          <span class="task-count">3</span>
        </h5>
      </div>
      <div class="kanban-body">
        <div class="kanban-card">
          <div class="card-title">Implementar sistema de autenticación</div>
          <div class="card-meta">
            <div class="d-flex align-items-center gap-2">
              <span class="task-priority priority-high"></span>
              <span class="task-id">TASK-001</span>
            </div>
            <div class="task-assignee">ER</div>
          </div>
        </div>
        
        <div class="kanban-card">
          <div class="card-title">Diseñar interfaz de usuario</div>
          <div class="card-meta">
            <div class="d-flex align-items-center gap-2">
              <span class="task-priority priority-medium"></span>
              <span class="task-id">TASK-002</span>
            </div>
            <div class="task-assignee">JD</div>
          </div>
        </div>
        
        <div class="kanban-card">
          <div class="card-title">Configurar base de datos</div>
          <div class="card-meta">
            <div class="d-flex align-items-center gap-2">
              <span class="task-priority priority-low"></span>
              <span class="task-id">TASK-003</span>
            </div>
            <div class="task-assignee">MG</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Columna In Progress -->
    <div class="kanban-column column-progress">
      <div class="kanban-header">
        <h5 class="d-flex align-items-center">
          En Progreso
          <span class="task-count">2</span>
        </h5>
      </div>
      <div class="kanban-body">
        <div class="kanban-card">
          <div class="card-title">Desarrollar API REST</div>
          <div class="card-meta">
            <div class="d-flex align-items-center gap-2">
              <span class="task-priority priority-high"></span>
              <span class="task-id">TASK-004</span>
            </div>
            <div class="task-assignee">ER</div>
          </div>
        </div>
        
        <div class="kanban-card">
          <div class="card-title">Integrar sistema de pagos</div>
          <div class="card-meta">
            <div class="d-flex align-items-center gap-2">
              <span class="task-priority priority-medium"></span>
              <span class="task-id">TASK-005</span>
            </div>
            <div class="task-assignee">AB</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Columna Review -->
    <div class="kanban-column column-review">
      <div class="kanban-header">
        <h5 class="d-flex align-items-center">
          En Revisión
          <span class="task-count">1</span>
        </h5>
      </div>
      <div class="kanban-body">
        <div class="kanban-card">
          <div class="card-title">Pruebas de integración</div>
          <div class="card-meta">
            <div class="d-flex align-items-center gap-2">
              <span class="task-priority priority-medium"></span>
              <span class="task-id">TASK-006</span>
            </div>
            <div class="task-assignee">QA</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Columna Done -->
    <div class="kanban-column column-done">
      <div class="kanban-header">
        <h5 class="d-flex align-items-center">
          Completado
          <span class="task-count">2</span>
        </h5>
      </div>
      <div class="kanban-body">
        <div class="kanban-card">
          <div class="card-title">Setup inicial del proyecto</div>
          <div class="card-meta">
            <div class="d-flex align-items-center gap-2">
              <span class="task-priority priority-low"></span>
              <span class="task-id">TASK-007</span>
            </div>
            <div class="task-assignee">ER</div>
          </div>
        </div>
        
        <div class="kanban-card">
          <div class="card-title">Documentación técnica</div>
          <div class="card-meta">
            <div class="d-flex align-items-center gap-2">
              <span class="task-priority priority-low"></span>
              <span class="task-id">TASK-008</span>
            </div>
            <div class="task-assignee">TW</div>
          </div>
        </div>
      </div>
    </div>

  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    let draggedElement = null;

    // Hacer todas las tarjetas arrastrables
    function makeCardsDraggable() {
        const cards = document.querySelectorAll('.kanban-card');
        cards.forEach(card => {
            card.draggable = true;
            
            card.addEventListener('dragstart', function(e) {
                draggedElement = this;
                this.style.opacity = '0.5';
                e.dataTransfer.effectAllowed = 'move';
            });

            card.addEventListener('dragend', function(e) {
                this.style.opacity = '1';
                draggedElement = null;
            });
        });
    }

    // Hacer las columnas receptoras de drop
    function makeColumnsDroppable() {
        const columns = document.querySelectorAll('.kanban-body');
        columns.forEach(column => {
            
            column.addEventListener('dragover', function(e) {
                e.preventDefault();
                e.dataTransfer.dropEffect = 'move';
                
                const afterElement = getDragAfterElement(column, e.clientY);
                if (afterElement == null) {
                    column.appendChild(createDropIndicator());
                } else {
                    column.insertBefore(createDropIndicator(), afterElement);
                }
            });

            column.addEventListener('dragleave', function(e) {
                // Solo remover si realmente salimos de la columna
                if (!column.contains(e.relatedTarget)) {
                    removeDropIndicators();
                }
            });

            column.addEventListener('drop', function(e) {
                e.preventDefault();
                removeDropIndicators();
                
                if (draggedElement) {
                    const afterElement = getDragAfterElement(column, e.clientY);
                    if (afterElement == null) {
                        column.appendChild(draggedElement);
                    } else {
                        column.insertBefore(draggedElement, afterElement);
                    }
                    updateTaskCounts();
                }
            });
        });
    }

    // Obtener el elemento después del cual insertar
    function getDragAfterElement(container, y) {
        const draggableElements = [...container.querySelectorAll('.kanban-card:not(.dragging)')];
        
        return draggableElements.reduce((closest, child) => {
            const box = child.getBoundingClientRect();
            const offset = y - box.top - box.height / 2;
            
            if (offset < 0 && offset > closest.offset) {
                return { offset: offset, element: child };
            } else {
                return closest;
            }
        }, { offset: Number.NEGATIVE_INFINITY }).element;
    }

    // Crear indicador visual de drop
    function createDropIndicator() {
        removeDropIndicators(); // Remover existentes
        const indicator = document.createElement('div');
        indicator.className = 'drop-indicator';
        indicator.style.cssText = `
            height: 2px;
            background: #0d6efd;
            margin: 8px 0;
            border-radius: 1px;
            opacity: 0.8;
        `;
        return indicator;
    }

    // Remover indicadores de drop
    function removeDropIndicators() {
        document.querySelectorAll('.drop-indicator').forEach(indicator => {
            indicator.remove();
        });
    }

    // Actualizar contadores de tareas
    function updateTaskCounts() {
        document.querySelectorAll('.kanban-column').forEach(column => {
            const count = column.querySelectorAll('.kanban-card').length;
            const counter = column.querySelector('.task-count');
            if (counter) {
                counter.textContent = count;
            }
        });
    }

    // Inicializar funcionalidad
    makeCardsDraggable();
    makeColumnsDroppable();

    // Actualizar contadores iniciales
    updateTaskCounts();
});
</script>
{% endblock %}