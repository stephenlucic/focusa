{% extends 'base.html' %}
{% load static %}

{% block title %}Focusa | Kanban Board{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/kanban.css' %}">
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <h2 class="mb-0">Tablero Kanban</h2>
  <div class="d-flex gap-2">
    <button class="btn btn-outline-secondary" type="button" data-bs-toggle="modal" data-bs-target="#newTagModal">
      <i class="bi bi-bookmark-plus"></i> Nuevo Tag
    </button>
    <button class="btn btn-primary" type="button" data-bs-toggle="modal" data-bs-target="#newTaskModal">
      <i class="bi bi-plus-lg"></i> Nueva Tarea
    </button>
  </div>
</div>

<div class="card tablero-card rounded-5">
  <div class="card-body p-3">
    <div class="kanban-container">
      <div class="kanban-board">
        
        <!-- Columna To Do -->
        <div class="kanban-column column-todo" data-status="todo">
          <div class="kanban-header">
            <h5 class="d-flex align-items-center">
              Por Hacer
              <span class="task-count">0</span>
            </h5>
          </div>
          <div class="kanban-body">
            {% for tarea in tareas_todo %}
              <div class="kanban-card task-card" data-id="{{ tarea.id }}">
                <div class="card-title d-flex align-items-center gap-2">
                  {% if tarea.prioridad == "alta" %}
                    <span class="task-priority priority-high"></span>
                  {% elif tarea.prioridad == "media" %}
                    <span class="task-priority priority-medium"></span>
                  {% else %}
                    <span class="task-priority priority-low"></span>
                  {% endif %}
                  <span>{{ tarea.titulo }}</span>
                </div>
                <div class="card-meta d-flex justify-content-between align-items-center">
                  <div class="d-flex align-items-center gap-2">
                    <small class="text-muted">
                      {{ tarea.fecha_desde|date:"d/m" }}{% if tarea.fecha_hasta %} - {{ tarea.fecha_hasta|date:"d/m" }}{% endif %}
                    </small>
                  </div>
                  <div class="d-flex align-items-center gap-2">
                    {% if tarea.tag %}
                      <span class="badge rounded-pill"
                            style="background-color: {{ tarea.tag.color }};">
                        {{ tarea.tag.nombre }}
                      </span>
                    {% endif %}
                    <div class="task-assignee">
                      {{ tarea.responsable.first_name|default:tarea.responsable.username|slice:":2"|upper }}
                    </div>
                  </div>
                </div>
              </div>
            {% empty %}
              <p class="text-muted small mb-0">No hay tareas por hacer.</p>
            {% endfor %}
          </div>
        </div>

        <!-- Columna In Progress -->
        <div class="kanban-column column-progress" data-status="progress">
          <div class="kanban-header">
            <h5 class="d-flex align-items-center">
              En Progreso
              <span class="task-count">0</span>
            </h5>
          </div>
          <div class="kanban-body">
            {% for tarea in tareas_progress %}
              <div class="kanban-card task-card" data-id="{{ tarea.id }}">
                <div class="card-title d-flex align-items-center gap-2">
                  {% if tarea.prioridad == "alta" %}
                    <span class="task-priority priority-high"></span>
                  {% elif tarea.prioridad == "media" %}
                    <span class="task-priority priority-medium"></span>
                  {% else %}
                    <span class="task-priority priority-low"></span>
                  {% endif %}
                  <span>{{ tarea.titulo }}</span>
                </div>
                <div class="card-meta d-flex justify-content-between align-items-center">
                  <div class="d-flex align-items-center gap-2">
                    <small class="text-muted">
                      {{ tarea.fecha_desde|date:"d/m" }}{% if tarea.fecha_hasta %} - {{ tarea.fecha_hasta|date:"d/m" }}{% endif %}
                    </small>
                  </div>
                  <div class="d-flex align-items-center gap-2">
                    {% if tarea.tag %}
                      <span class="badge rounded-pill"
                            style="background-color: {{ tarea.tag.color }};">
                        {{ tarea.tag.nombre }}
                      </span>
                    {% endif %}
                    <div class="task-assignee">
                      {{ tarea.responsable.first_name|default:tarea.responsable.username|slice:":2"|upper }}
                    </div>
                  </div>
                </div>
              </div>
            {% empty %}
              <p class="text-muted small mb-0">No hay tareas en progreso.</p>
            {% endfor %}
          </div>
        </div>

        <!-- Columna Review -->
        <div class="kanban-column column-review" data-status="review">
          <div class="kanban-header">
            <h5 class="d-flex align-items-center">
              En Revisión
              <span class="task-count">0</span>
            </h5>
          </div>
          <div class="kanban-body">
            {% for tarea in tareas_review %}
              <div class="kanban-card task-card" data-id="{{ tarea.id }}">
                <div class="card-title d-flex align-items-center gap-2">
                  {% if tarea.prioridad == "alta" %}
                    <span class="task-priority priority-high"></span>
                  {% elif tarea.prioridad == "media" %}
                    <span class="task-priority priority-medium"></span>
                  {% else %}
                    <span class="task-priority priority-low"></span>
                  {% endif %}
                  <span>{{ tarea.titulo }}</span>
                </div>
                <div class="card-meta d-flex justify-content-between align-items-center">
                  <div class="d-flex align-items-center gap-2">
                    <small class="text-muted">
                      {{ tarea.fecha_desde|date:"d/m" }}{% if tarea.fecha_hasta %} - {{ tarea.fecha_hasta|date:"d/m" }}{% endif %}
                    </small>
                  </div>
                  <div class="d-flex align-items-center gap-2">
                    {% if tarea.tag %}
                      <span class="badge rounded-pill"
                            style="background-color: {{ tarea.tag.color }};">
                        {{ tarea.tag.nombre }}
                      </span>
                    {% endif %}
                    <div class="task-assignee">
                      {{ tarea.responsable.first_name|default:tarea.responsable.username|slice:":2"|upper }}
                    </div>
                  </div>
                </div>
              </div>
            {% empty %}
              <p class="text-muted small mb-0">No hay tareas en revisión.</p>
            {% endfor %}
          </div>
        </div>

        <!-- Columna Done -->
        <div class="kanban-column column-done" data-status="done">
          <div class="kanban-header">
            <h5 class="d-flex align-items-center">
              Completado
              <span class="task-count">0</span>
            </h5>
          </div>
          <div class="kanban-body">
            {% for tarea in tareas_done %}
              <div class="kanban-card task-card" data-id="{{ tarea.id }}">
                <div class="card-title d-flex align-items-center gap-2">
                  {% if tarea.prioridad == "alta" %}
                    <span class="task-priority priority-high"></span>
                  {% elif tarea.prioridad == "media" %}
                    <span class="task-priority priority-medium"></span>
                  {% else %}
                    <span class="task-priority priority-low"></span>
                  {% endif %}
                  <span>{{ tarea.titulo }}</span>
                </div>
                <div class="card-meta d-flex justify-content-between align-items-center">
                  <div class="d-flex align-items-center gap-2">
                    <small class="text-muted">
                      {{ tarea.fecha_desde|date:"d/m" }}{% if tarea.fecha_hasta %} - {{ tarea.fecha_hasta|date:"d/m" }}{% endif %}
                    </small>
                  </div>
                  <div class="d-flex align-items-center gap-2">
                    {% if tarea.tag %}
                      <span class="badge rounded-pill"
                            style="background-color: {{ tarea.tag.color }};">
                        {{ tarea.tag.nombre }}
                      </span>
                    {% endif %}
                    <div class="task-assignee">
                      {{ tarea.responsable.first_name|default:tarea.responsable.username|slice:":2"|upper }}
                    </div>
                  </div>
                </div>
              </div>
            {% empty %}
              <p class="text-muted small mb-0">No hay tareas completadas.</p>
            {% endfor %}
          </div>
        </div>

      </div>
    </div>
  </div>
</div>  

<!-- Modal Nueva Tarea -->
<div class="modal fade" id="newTaskModal" tabindex="-1" aria-labelledby="newTaskModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="newTaskModalLabel">Nueva Tarea</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>
      <div class="modal-body">
        <form id="newTaskForm" method="post" enctype="multipart/form-data">
          {% csrf_token %}
          <div class="mb-3">
            <label for="taskTitle" class="form-label">Título</label>
            <input type="text" class="form-control" id="taskTitle" name="title" placeholder="Ingresa el título de la tarea" required>
          </div>

          <div class="mb-3">
            <label for="taskDescription" class="form-label">Descripción</label>
            <textarea class="form-control" id="taskDescription" name="description" rows="3" placeholder="Describe brevemente la tarea"></textarea>
          </div>

          <div class="row g-3">
            <div class="col-md-6">
              <label for="taskPriority" class="form-label">Prioridad</label>
              <select class="form-select" id="taskPriority" name="priority">
                <option value="alta">Alta</option>
                <option value="media" selected>Media</option>
                <option value="baja">Baja</option>
              </select>
            </div>

            <div class="col-md-6">
              <label for="taskStatus" class="form-label">Estado</label>
              <select class="form-select" id="taskStatus" name="status">
                <option value="todo" selected>Por hacer</option>
                <option value="progress">En progreso</option>
                <option value="review">En revisión</option>
                <option value="done">Completado</option>
              </select>
            </div>
          </div>

          <div class="row g-3 mt-1">
            <div class="col-md-6">
              <label for="taskStartDate" class="form-label">Fecha desde</label>
              <input type="date" class="form-control" id="taskStartDate" name="start_date">
            </div>

            <div class="col-md-6">
              <label for="taskEndDate" class="form-label">Fecha hasta</label>
              <input type="date" class="form-control" id="taskEndDate" name="end_date">
            </div>
          </div>

          <div class="mt-3">
            <label for="taskTag" class="form-label">Tag</label>
            <select class="form-select" id="taskTag" name="tag">
              <option value="" selected>Selecciona un tag</option>
              {% for tag in tags %}
                <option value="{{ tag.id }}">{{ tag.nombre }}</option>
              {% endfor %}
            </select>
          </div>

          <div class="mt-3">
            <label for="taskAttachment" class="form-label">Adjunto</label>
            <input class="form-control" type="file" id="taskAttachment" name="attachment">
          </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button type="submit" class="btn btn-primary">Guardar</button>
      </div>
        </form>
    </div>
  </div>
</div>

<!-- Modal Nuevo Tag -->
<div class="modal fade" id="newTagModal" tabindex="-1" aria-labelledby="newTagModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="newTagModalLabel">Nuevo Tag</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>
      <div class="modal-body">
        <!-- IMPORTANTE: method="post" y csrf_token -->
        <form id="newTagForm" method="post">
          {% csrf_token %}
          <input type="hidden" name="action" value="create_tag">
          <div class="mb-3">
            <label for="tagName" class="form-label">Nombre del tag</label>
            <input type="text" class="form-control" id="tagName" name="name" placeholder="Ej: Backend, Urgente, Diseño" required>
          </div>

          <div class="mb-3">
            <label for="tagColor" class="form-label">Color</label>
            <input type="color" class="form-control form-control-color" id="tagColor" name="color" value="#0d6efd" title="Elige un color para el tag">
          </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        <!-- botón submit real del form -->
        <button type="submit" class="btn btn-primary">Guardar</button>
      </div>
        </form>
    </div>
  </div>
</div>


<!-- Modal Detalle / Editar Tarea -->
<div class="modal fade" id="taskDetailModal" tabindex="-1" aria-labelledby="taskDetailModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="taskDetailModalLabel">Detalle de Tarea</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>
      <div class="modal-body">
        <form id="taskDetailForm">
          {% csrf_token %}
          <input type="hidden" id="detailTaskId">
          
          <div class="mb-3">
            <label for="detailTaskTitle" class="form-label">Título</label>
            <input type="text" class="form-control" id="detailTaskTitle" name="title" required>
          </div>

          <div class="mb-3">
            <label for="detailTaskDescription" class="form-label">Descripción</label>
            <textarea class="form-control" id="detailTaskDescription" name="description" rows="3"></textarea>
          </div>

          <div class="row g-3">
            <div class="col-md-6">
              <label for="detailTaskPriority" class="form-label">Prioridad</label>
              <select class="form-select" id="detailTaskPriority" name="priority">
                <option value="alta">Alta</option>
                <option value="media">Media</option>
                <option value="baja">Baja</option>
              </select>
            </div>

            <div class="col-md-6">
              <label for="detailTaskStatus" class="form-label">Estado</label>
              <select class="form-select" id="detailTaskStatus" name="status">
                <option value="todo">Por hacer</option>
                <option value="progress">En progreso</option>
                <option value="review">En revisión</option>
                <option value="done">Completado</option>
              </select>
            </div>
          </div>

          <div class="row g-3 mt-1">
            <div class="col-md-6">
              <label for="detailTaskStartDate" class="form-label">Fecha desde</label>
              <input type="date" class="form-control" id="detailTaskStartDate" name="start_date">
            </div>

            <div class="col-md-6">
              <label for="detailTaskEndDate" class="form-label">Fecha hasta</label>
              <input type="date" class="form-control" id="detailTaskEndDate" name="end_date">
            </div>
          </div>

          <div class="mt-3">
            <label for="detailTaskTag" class="form-label">Tag</label>
            <select class="form-select" id="detailTaskTag" name="tag">
              <option value="">Sin tag</option>
              {% for tag in tags %}
                <option value="{{ tag.id }}">{{ tag.nombre }}</option>
              {% endfor %}
            </select>
          </div>

        </form>
        <div id="taskDetailError" class="text-danger small mt-2" style="display:none;"></div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
        <button type="button" class="btn btn-outline-primary" id="editTaskDetailBtn">Editar</button>
        <button type="button" class="btn btn-primary" id="saveTaskDetailBtn" disabled>Guardar cambios</button>
      </div>
    </div>
  </div>
</div>


{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    let draggedElement = null;

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    const csrftoken = getCookie('csrftoken');

    // --- drag & drop (sin cambios) ---
    function makeCardsDraggable() {
        const cards = document.querySelectorAll('.kanban-card');
        cards.forEach(card => {
            card.draggable = true;
            card.addEventListener('dragstart', function(e) {
                draggedElement = this;
                this.classList.add('dragging');
                this.style.opacity = '0.5';
                e.dataTransfer.effectAllowed = 'move';
            });
            card.addEventListener('dragend', function(e) {
                this.style.opacity = '1';
                this.classList.remove('dragging');
                draggedElement = null;
                removeDropIndicators();
            });
        });
    }

    function makeColumnsDroppable() {
        const columns = document.querySelectorAll('.kanban-body');
        columns.forEach(column => {
            column.addEventListener('dragover', function(e) {
                e.preventDefault();
                e.dataTransfer.dropEffect = 'move';
                const afterElement = getDragAfterElement(column, e.clientY);
                if (afterElement == null) {
                    column.appendChild(createDropIndicator());
                } else {
                    column.insertBefore(createDropIndicator(), afterElement);
                }
            });

            column.addEventListener('dragleave', function(e) {
                if (!column.contains(e.relatedTarget)) {
                    removeDropIndicators();
                }
            });

            column.addEventListener('drop', function(e) {
                e.preventDefault();
                removeDropIndicators();
                if (draggedElement) {
                    const afterElement = getDragAfterElement(column, e.clientY);
                    if (afterElement == null) {
                        column.appendChild(draggedElement);
                    } else {
                        column.insertBefore(draggedElement, afterElement);
                    }
                    updateTaskCounts();
                    const taskId = draggedElement.getAttribute('data-id');
                    const col = column.closest('.kanban-column');
                    const nuevoEstado = col ? col.getAttribute('data-status') : null;
                    if (taskId && nuevoEstado) {
                        fetch("{% url 'kanban_actualizar_estado' %}", {
                            method: "POST",
                            headers: {
                                "X-CSRFToken": csrftoken,
                                "X-Requested-With": "XMLHttpRequest",
                                "Content-Type": "application/x-www-form-urlencoded",
                            },
                            body: new URLSearchParams({ id: taskId, estado: nuevoEstado })
                        }).then(r => r.json()).then(data => {
                            if (!data.ok) console.error("Error al actualizar estado:", data.error);
                        }).catch(err => console.error("Error de red:", err));
                    }
                }
            });
        });
    }

    function getDragAfterElement(container, y) {
        const draggableElements = [...container.querySelectorAll('.kanban-card:not(.dragging)')];
        return draggableElements.reduce((closest, child) => {
            const box = child.getBoundingClientRect();
            const offset = y - box.top - box.height / 2;
            if (offset < 0 && offset > closest.offset) {
                return { offset: offset, element: child };
            } else {
                return closest;
            }
        }, { offset: Number.NEGATIVE_INFINITY }).element;
    }

    function createDropIndicator() {
        removeDropIndicators();
        const indicator = document.createElement('div');
        indicator.className = 'drop-indicator';
        indicator.style.cssText = `
            height: 2px;
            background: #0d6efd;
            margin: 8px 0;
            border-radius: 1px;
            opacity: 0.8;
        `;
        return indicator;
    }

    function removeDropIndicators() {
        document.querySelectorAll('.drop-indicator').forEach(indicator => indicator.remove());
    }

    function updateTaskCounts() {
        document.querySelectorAll('.kanban-column').forEach(column => {
            const count = column.querySelectorAll('.kanban-card').length;
            const counter = column.querySelector('.task-count');
            if (counter) counter.textContent = count;
        });
    }

    makeCardsDraggable();
    makeColumnsDroppable();
    updateTaskCounts();

    // --- Detalle / edición ---
    const taskCards = document.querySelectorAll('.kanban-card');
    const taskDetailModalEl = document.getElementById('taskDetailModal');
    const taskDetailModal = taskDetailModalEl ? new bootstrap.Modal(taskDetailModalEl) : null;
    const editBtn = document.getElementById('editTaskDetailBtn');
    const saveBtn = document.getElementById('saveTaskDetailBtn');
    const formEl = document.getElementById('taskDetailForm');

    function setFormEditable(isEditable) {
        const fields = formEl.querySelectorAll('input, textarea, select');
        fields.forEach(f => {
            if (f.id === 'detailTaskId') return; // siempre hidden
            f.disabled = !isEditable;
        });
        if (isEditable) {
            editBtn.textContent = 'Cancelar edición';
            editBtn.classList.remove('btn-outline-primary');
            editBtn.classList.add('btn-outline-secondary');
            saveBtn.disabled = false;
        } else {
            editBtn.textContent = 'Editar';
            editBtn.classList.remove('btn-outline-secondary');
            editBtn.classList.add('btn-outline-primary');
            saveBtn.disabled = true;
        }
    }

    // al inicio: formulario solo lectura
    setFormEditable(false);

    taskCards.forEach(card => {
        card.addEventListener('click', function() {
            if (this.classList.contains('dragging')) return;

            const taskId = this.getAttribute('data-id');
            if (!taskId || !taskDetailModal) return;

            document.getElementById('taskDetailError').style.display = 'none';
            formEl.reset();
            document.getElementById('detailTaskId').value = taskId;
            setFormEditable(false); // siempre abrir en modo lectura

            fetch(`{% url 'kanban_tarea_detalle' 0 %}`.replace('/0/', `/${taskId}/`), {
                method: 'GET',
                headers: { 'X-Requested-With': 'XMLHttpRequest' }
            })
            .then(resp => resp.json())
            .then(data => {
                if (!data.ok) {
                    document.getElementById('taskDetailError').textContent = data.error || 'Error al cargar la tarea.';
                    document.getElementById('taskDetailError').style.display = 'block';
                    return;
                }
                const t = data.tarea;
                document.getElementById('detailTaskTitle').value = t.titulo || '';
                document.getElementById('detailTaskDescription').value = t.descripcion || '';
                document.getElementById('detailTaskPriority').value = t.prioridad || 'media';
                document.getElementById('detailTaskStatus').value = t.estado || 'todo';
                document.getElementById('detailTaskStartDate').value = t.fecha_desde || '';
                document.getElementById('detailTaskEndDate').value = t.fecha_hasta || '';
                document.getElementById('detailTaskTag').value = t.tag_id || '';

                taskDetailModal.show();
            })
            .catch(err => {
                console.error(err);
                document.getElementById('taskDetailError').textContent = 'Error de red al cargar la tarea.';
                document.getElementById('taskDetailError').style.display = 'block';
            });
        });
    });

    if (editBtn) {
        editBtn.addEventListener('click', function() {
            const nowEditable = saveBtn.disabled; // si save está deshabilitado, pasamos a editable
            setFormEditable(nowEditable);
            // si se cancela edición, volvemos a cargar valores desde servidor sería ideal,
            // pero para mantenerlo simple dejamos los cambios en el form sin guardar.
        });
    }

    if (saveBtn) {
        saveBtn.addEventListener('click', function() {
            if (saveBtn.disabled) return; // no hacer nada si está en modo solo lectura
            const taskId = document.getElementById('detailTaskId').value;
            if (!taskId) return;

            const formData = new FormData(formEl);

            fetch(`{% url 'kanban_tarea_detalle' 0 %}`.replace('/0/', `/${taskId}/`), {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrftoken,
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: formData
            })
            .then(resp => resp.json())
            .then(data => {
                if (!data.ok) {
                    document.getElementById('taskDetailError').textContent = data.error || 'Error al guardar los cambios.';
                    document.getElementById('taskDetailError').style.display = 'block';
                    return;
                }
                location.reload();
            })
            .catch(err => {
                console.error(err);
                document.getElementById('taskDetailError').textContent = 'Error de red al guardar.';
                document.getElementById('taskDetailError').style.display = 'block';
            });
        });
    }
});
</script>
{% endblock %}