{% extends "base.html" %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/calendario.css' %}">
{% endblock %}

{% block title %}Calendario | Focusa{% endblock %}

{% block content %}

<div class="calendar-wrapper">
    <div id="calendar"></div>
</div>

{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.19/index.global.min.js"></script>
<script src="{% static 'calendario/fullcalendar-6.1.19/locales-all.global.min.js' %}"></script>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const estadoMap = {
    todo: "Por hacer",
    progress: "En proceso",
    review: "En revisión",
    done: "Completada"
  };

  const calendar = new FullCalendar.Calendar(document.getElementById("calendar"), {
    initialView: "dayGridMonth",
    locale: "es",
    firstDay: 1,
    headerToolbar: {
      left: "prev,next today",
      center: "title",
      right: "dayGridMonth,listWeek"
    },
    buttonText: {
      today: "Hoy",
      month: "Mes",
      list: "Lista"
    },
    dayHeaderFormat: { weekday: "long" },
    weekNumbers: false,
    nowIndicator: true,
    height: "auto",
    events: window.location.pathname + "?events=1",

    datesSet(info) {
      const titleEl = document.querySelector(".fc-toolbar-title");
      if (!titleEl) return;

      const view = info.view;
      if (view.type.startsWith("list")) {
        const start = view.currentStart;
        const end = new Date(view.currentEnd);
        end.setDate(end.getDate() - 1); // fin inclusivo
        const month = start.toLocaleDateString("es-ES", { month: "long" });
        const monthCap = month.charAt(0).toUpperCase() + month.slice(1);
        titleEl.textContent = `${start.getDate()} – ${end.getDate()} ${monthCap} ${start.getFullYear()}`;
      } else {
        let txt = view.title.replace(" de ", " "); // Noviembre 2025
        txt = txt.charAt(0).toUpperCase() + txt.slice(1);
        titleEl.textContent = txt;
      }
    },
    eventDidMount: function(info){
      const p = info.event.extendedProps.prioridad || "-";
      const e = estadoMap[info.event.extendedProps.estado] || info.event.extendedProps.estado;
      info.el.setAttribute("title", `Prioridad: ${p}\nEstado: ${e}`);
    }
  });
  calendar.render();
});
</script>
{% endblock %}